name: Unity iOS Build (Automatic Signing)

on:
  workflow_call:
    inputs:
      unity_version:
        required: true
        type: string
        description: 'Unity version to use (e.g., 2022.3.26f1)'
      build_method:
        required: true
        type: string
        description: 'Unity build method to call (e.g., RemoteBuilder.BuildiOS)'
      repository:
        required: true
        type: string
        description: 'Repository to build'
      artifact_name:
        required: true
        type: string
        description: 'Name for the artifact to upload'
      team_id:
        required: true
        type: string
        description: 'Apple Team ID'
      app_bundle_id:
        required: true
        type: string
        description: 'iOS app bundle identifier (e.g., com.luckyjackpotcasino.kenocasino)'
    secrets:
      GH_SSH_KEY:
        required: false
      APP_STORE_CONNECT_API_KEY_ID:
        required: true
      APP_STORE_CONNECT_API_ISSUER_ID:
        required: true
      APP_STORE_CONNECT_API_KEY_CONTENT:
        required: true
      IOS_DISTRIBUTION_CERT_P12:
        required: true
      IOS_DISTRIBUTION_CERT_PASSWORD:
        required: true

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 180
    env:
      API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      TEAM_ID: ${{ inputs.team_id }}
    
    steps:
      - name: Update Repository (Persistent Workspace)
        run: |
          # Configure SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          
          # Check if this is first run (no .git folder)
          if [ ! -d ".git" ]; then
            echo "üÜï First build - cloning repository..."
            git clone --depth 1 --recurse-submodules --shallow-submodules \
              git@github.com:${{ inputs.repository }}.git .
          else
            echo "‚ôªÔ∏è  Workspace exists - updating (much faster!)..."
            git fetch --depth 1 origin master
            git reset --hard origin/master
            git submodule update --init --recursive --depth 1
          fi
          
          echo "‚úÖ Repository ready (Library folder preserved for speed)"

      - name: Ensure Unity is not running (shared workspace safety)
        run: |
          # Shared workspace + someone opening the project in the Editor can break CI.
          # Ensure no Unity Editor instance is holding the project open.
          echo "üõë Ensuring Unity is not running..."
          pkill -f "/Applications/Unity/Hub/Editor" || true
          pkill -x "Unity" || true
          pkill -x "Unity Hub" || true
          pkill -x "UnityPackageManager" || true
          
          # Remove any leftover lock file if present
          rm -f "$(pwd)/Temp/UnityLockfile" 2>/dev/null || true
          echo "‚úÖ Unity process/lock cleanup complete"
      
      # No cache needed - Library folder stays on disk between builds!
      
      - name: Build iOS with Unity
        env:
          BUILD_NUMBER: ${{ github.run_number }}
          JOB_NAME: ${{ github.workflow }}
        run: |
          UNITY_PATH="/Applications/Unity/Hub/Editor/${{ inputs.unity_version }}/Unity.app/Contents/MacOS/Unity"
          
          # Fallback to any available Unity version if exact version not found
          if [ ! -f "$UNITY_PATH" ]; then
            UNITY_PATH=$(find /Applications/Unity/Hub/Editor -name "Unity" -type f | head -1)
            echo "‚ö†Ô∏è  Using Unity at: $UNITY_PATH"
          fi
          
          echo "üéÆ Starting Unity iOS build..."
          echo "Build Method: ${{ inputs.build_method }}"
          echo "Build Number: $BUILD_NUMBER"
          
          # Run Unity build to generate Xcode project
          "$UNITY_PATH" \
            -quit \
            -batchmode \
            -nographics \
            -projectPath "$(pwd)" \
            -executeMethod ${{ inputs.build_method }} \
            -logFile /tmp/unity-build.log
          
          UNITY_EXIT=$?
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "Unity Build Log (last 100 lines):"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          tail -100 /tmp/unity-build.log
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          
          if [ $UNITY_EXIT -ne 0 ]; then
            echo "‚ùå Unity build failed with exit code: $UNITY_EXIT"
            exit $UNITY_EXIT
          fi
          
          echo "‚úÖ Unity build command completed"
      
      - name: Verify iOS Project Created
        run: |
          echo "üìÇ Checking for iOS project..."
          if [ -d "IosProjectFolder" ]; then
            echo "‚úÖ IosProjectFolder exists!"
            ls -la IosProjectFolder/ | head -20
          else
            echo "‚ùå IosProjectFolder not found. Unity build failed!"
            exit 1
          fi
      
      - name: Add Export Compliance to Info.plist
        working-directory: IosProjectFolder
        run: |
          echo "üîê Adding encryption export compliance..."
          /usr/libexec/PlistBuddy -c "Add :ITSAppUsesNonExemptEncryption bool false" Info.plist 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :ITSAppUsesNonExemptEncryption false" Info.plist
          echo "‚úÖ Export compliance added (None of the algorithms mentioned)"
      
      - name: Setup Signing with Fastlane Match
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: git@github.com:LuckyJackpotCasino/ios-certificates.git
        run: |
          # Install fastlane if needed
          if ! command -v /Users/stephensullivan/.gem/ruby/3.2.0/bin/fastlane &> /dev/null; then
            echo "Installing fastlane..."
            gem install fastlane --user-install
          fi
          
          FASTLANE=/Users/stephensullivan/.gem/ruby/3.2.0/bin/fastlane
          
          # Setup App Store Connect API key
          mkdir -p ~/private_keys
          echo "${{ env.API_KEY_CONTENT }}" | base64 --decode > ~/private_keys/AuthKey_${{ env.API_KEY_ID }}.p8
          chmod 600 ~/private_keys/AuthKey_${{ env.API_KEY_ID }}.p8
          
          # Create Match configuration
          mkdir -p fastlane
          cat > fastlane/Matchfile << 'MATCHFILE'
          git_url(ENV["MATCH_GIT_URL"])
          storage_mode("git")
          type("appstore")
          git_branch("main")
          username("stephen@luckyjackpotcasino.com")
          team_id("${{ env.TEAM_ID }}")
          app_identifier(["${{ inputs.app_bundle_id }}"])
          MATCHFILE
          
          cat > fastlane/Fastfile << 'FASTFILE'
          default_platform(:ios)
          
          platform :ios do
            lane :sync do
              api_key = app_store_connect_api_key(
                key_id: ENV["API_KEY_ID"],
                issuer_id: ENV["API_ISSUER_ID"],
                key_filepath: "#{ENV['HOME']}/private_keys/AuthKey_#{ENV['API_KEY_ID']}.p8",
                in_house: false
              )
              
              match(
                type: "appstore",
                api_key: api_key,
                readonly: true,
                verbose: true
              )
            end
          end
          FASTFILE
          
          export API_KEY_ID="${{ env.API_KEY_ID }}"
          export API_ISSUER_ID="${{ env.API_ISSUER_ID }}"
          
          echo "üîê Syncing certificates and profiles with Match..."
          $FASTLANE sync
          
          # Capture the installed profile UUID + name for later xcodebuild signing settings.
          # (Fastlane prints these but doesn't export them to subsequent steps.)
          PROFILE_PATH=$(ls -t "$HOME/Library/MobileDevice/Provisioning Profiles/"*.mobileprovision 2>/dev/null | head -1)
          if [ -z "$PROFILE_PATH" ]; then
            echo "‚ùå No provisioning profile found after match!"
            exit 1
          fi
          
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$(security cms -D -i "$PROFILE_PATH")")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" /dev/stdin <<< "$(security cms -D -i "$PROFILE_PATH")")
          
          echo "‚úÖ Match installed profile:"
          echo "  - Path: $PROFILE_PATH"
          echo "  - UUID: $PROFILE_UUID"
          echo "  - Name: $PROFILE_NAME"
          
          echo "MATCH_PROFILE_UUID=$PROFILE_UUID" >> "$GITHUB_ENV"
          echo "MATCH_PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"
          
          echo "‚úÖ Match completed - certificates and profiles ready"
      
      - name: Setup CocoaPods
        run: |
          if ! command -v pod &> /dev/null; then
            echo "Installing CocoaPods..."
            gem install cocoapods --user-install
            export PATH="$HOME/.gem/ruby/$(ruby -e 'puts RUBY_VERSION')/bin:$PATH"
          fi
          pod --version
      
      - name: Fix Podfile Deployment Target
        working-directory: IosProjectFolder
        run: |
          echo "üîß Fixing deployment target in Podfile..."
          
          # Add post_install hook to set minimum iOS version
          if ! grep -q "post_install" Podfile; then
            cat >> Podfile << 'PODFILE'
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                if config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'].to_f < 13.0
                  config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
                end
              end
            end
          end
          PODFILE
            echo "‚úÖ Added deployment target fix to Podfile"
          else
            echo "Podfile already has post_install hook"
          fi
      
      - name: Install CocoaPods Dependencies
        working-directory: IosProjectFolder
        run: |
          export LC_ALL=en_US.UTF-8
          
          # Clean and update pods
          pod deintegrate || true
          rm -rf Pods Podfile.lock
          
          # Install fresh
          pod install
          
          echo "‚úÖ CocoaPods dependencies installed"
      
      - name: Configure Xcode Project for Manual Signing
        working-directory: IosProjectFolder
        run: |
          echo "üîß Configuring Xcode project for manual signing..."
          
          # Unity generates projects with automatic signing by default
          # Change to manual signing for CI with Match
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' Unity-iPhone.xcodeproj/project.pbxproj
          
          echo "‚úÖ Project configured for manual signing"
      
      - name: Clean Xcode Build
        working-directory: IosProjectFolder
        run: |
          echo "üßπ Deep cleaning Xcode build..."
          rm -rf build DerivedData
          
          xcodebuild clean \
            -workspace Unity-iPhone.xcworkspace \
            -scheme Unity-iPhone \
            -configuration Release
          
          echo "‚úÖ Clean complete"
      
      - name: Build Xcode Archive (Distribution)
        working-directory: IosProjectFolder
        run: |
          echo "üî® Building Xcode archive with automatic provisioning..."
          
          # Clean DerivedData to avoid stale signing state
          rm -rf ~/Library/Developer/Xcode/DerivedData/Unity-iPhone-*
          
          # Use Fastlane Match for signing (industry standard)
          # Match provides certificate and provisioning profile
          # Manual signing for deterministic, reproducible builds
          # Unity's pbxproj uses PROVISIONING_PROFILE(_SPECIFIER)_APP indirection, so set those.
          xcodebuild archive \
            -workspace Unity-iPhone.xcworkspace \
            -scheme Unity-iPhone \
            -configuration Release \
            -archivePath $GITHUB_WORKSPACE/Unity-iPhone.xcarchive \
            DEVELOPMENT_TEAM=${{ env.TEAM_ID }} \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution: Lucky Jackpot Casino LLC (D3H7LWSJL6)" \
            "CODE_SIGN_IDENTITY[sdk=iphoneos*]=Apple Distribution: Lucky Jackpot Casino LLC (D3H7LWSJL6)" \
            PROVISIONING_PROFILE_APP="${{ env.MATCH_PROFILE_UUID }}" \
            PROVISIONING_PROFILE_SPECIFIER_APP="${{ env.MATCH_PROFILE_NAME }}" \
            IPHONEOS_DEPLOYMENT_TARGET=13.0 \
            | tee /tmp/xcodebuild-archive.log
          
          XCODE_EXIT=${PIPESTATUS[0]}
          
          if [ $XCODE_EXIT -ne 0 ]; then
            echo "‚ùå Xcode archive failed!"
            echo "Last 100 lines of build log:"
            tail -100 /tmp/xcodebuild-archive.log
            exit $XCODE_EXIT
          fi
          
          echo "‚úÖ Xcode archive created for App Store distribution"
      
      - name: Export IPA
        run: |
          # Get bundle ID from Xcode project
          BUNDLE_ID=$(grep -A 2 "PRODUCT_BUNDLE_IDENTIFIER" IosProjectFolder/Unity-iPhone.xcodeproj/project.pbxproj | grep "com\." | head -1 | sed 's/.*= \(.*\);/\1/')
          
          cat > ExportOptions.plist <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>teamID</key>
            <string>${{ inputs.team_id }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>$BUNDLE_ID</key>
              <string>${{ env.MATCH_PROFILE_NAME }}</string>
            </dict>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          PLIST
          
          echo "üìã Export Options:"
          echo "  Bundle ID: $BUNDLE_ID"
          echo "  Match Profile Name: ${{ env.MATCH_PROFILE_NAME }}"
          echo "  Match Profile UUID: ${{ env.MATCH_PROFILE_UUID }}"
          echo "  Team ID: ${{ inputs.team_id }}"
          
          xcodebuild -exportArchive \
            -archivePath Unity-iPhone.xcarchive \
            -exportPath ./export \
            -exportOptionsPlist ExportOptions.plist
          
          echo "‚úÖ IPA exported"
          ls -lh export/*.ipa
      
      - name: Upload to TestFlight
        run: |
          IPA=$(find export -name "*.ipa" | head -1)
          echo "üì¶ Uploading: $IPA"
          
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA" \
            --apiKey ${{ env.API_KEY_ID }} \
            --apiIssuer ${{ env.API_ISSUER_ID }}
          
          echo "‚úÖ Uploaded to TestFlight!"
          echo "üéâ Build will appear in App Store Connect in 5-10 minutes"
      
      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up..."
          
          # Clean up files
          rm -rf *_BackUpThisFolder_ButDontShipItWithYourGame
          rm -f ~/private_keys/AuthKey_*.p8
          
          echo "‚úÖ Cleanup complete"

